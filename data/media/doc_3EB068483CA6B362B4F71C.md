# WhatsApp 认证重试机制技术文档

本文档详细介绍了 NanoClaw 项目中 `src/whatsapp-auth.ts` 脚本的 WhatsApp 认证流程及其
关联的重试与恢复机制。

## 概述

`src/whatsapp-auth.ts` 是一个关键的初始化工具，用于引导用户完成 WhatsApp 账号
与 NanoClaw 系统之间的身份验证。该脚本确保生成的认证凭证（Credentials）被安全
地持久化，并为后续主程序的自动重连奠定基础。

## 认证模式

您可以通过以下两种模式之一进行认证。

### 1. QR 码模式 (默认)
这是最直观的认证方式。脚本启动后，会从 WhatsApp 服务器请求一个二维码，并将其
渲染在终端界面。

- **操作步骤**：运行 `npx tsx src/whatsapp-auth.ts`。
- **刷新机制**：如果二维码在扫描前过期，系统会自动获取并刷新终端显示的 QR 码，
  您无需重启脚本即可继续尝试。

### 2. 验证码模式 (Pairing Mode)
适用于无法扫描二维码或希望远程配对的场景。

- **操作步骤**：运行 `npx tsx src/whatsapp-auth.ts <您的手机号>`。
- **重试保障**：脚本在发送配对码请求前设置了 3 秒的防御性延迟（Safe Delay），
  以规避由于连接尚未完全就绪导致的请求失败。

## 重试与容错机制

虽然该脚本主要用于一次性设置，但它在处理连接不稳定性方面具备多重保障。

### 1. 状态感知的重试建议
脚本监听 `connection.update` 事件，并根据 `lastDisconnect` 中的错误代码提供
精确的恢复建议：

- **退出登录 (Logged Out)**：当检测到 `DisconnectReason.loggedOut` 时，
  脚本会明确指示您删除 `store/auth` 目录，以清除无效的本地状态并开始全新的认证。
- **通用连接失败**：对于网络抖动等临时故障，脚本会通过 `process.exit(1)` 优雅
  终止，引导您手动重启进程。这种设计防止了在凭证不完整的情况下产生错误的本地
  文件。

### 2. 凭证持久化 (Persistence)
系统利用 `useMultiFileAuthState` 将认证状态保存至 `./store/auth`。
- **原子性**：只有在认证成功打开（`connection === 'open'`）后，凭证才被视为
  完全可用。
- **冲突保护**：如果检测到已注册凭证，脚本会拒绝运行并给出重置指引，避免覆盖
  正常的认证状态。

### 3. 连接超时管理
底层通信框架配置了以下参数以提高连接成功率：
- **连接超时**：60,000 毫秒（针对网络较差的环境）。
- **重试间隔**：内部请求失败时会有 1,000 毫秒的默认重试延迟（`retryRequestDelayMs`）。

## 与主程序重连机制的区别

请注意，`src/whatsapp-auth.ts` 专注于**初始认证的完整性**，遵循“失败即停止”
的原则以确保安全。一旦认证成功，主程序 (`src/index.ts`) 将接管连接，并执行更
复杂的自动退避（Exponential Backoff）重连逻辑。

## 下一步操作

1. 确认 `./store/auth` 目录已成功创建。
2. 运行 `npm run start` 启动 NanoClaw 主程序。
3. 若需更换账号，请手动删除 `./store/auth` 目录。
