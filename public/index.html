<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoClaw Tactical Terminal 5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes breathe { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.95); } }
        .status-breathe { animation: breathe 2s ease-in-out infinite; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .perf-node { height: 4px; border-radius: 2px; }
        .perf-pre { background-color: #10b981; }
        .perf-llm { background-color: #3b82f6; }
        .perf-post { background-color: #f59e0b; }
        
        .intent-tag { font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: 900; text-transform: uppercase; }
        .tag-visual_gen { background-color: #7e22ce; color: white; }
        .tag-data_analysis { background-color: #0369a1; color: white; }
        .tag-voice_gen { background-color: #be123c; color: white; }
        .tag-doc_summary { background-color: #15803d; color: white; }
        .tag-general { background-color: #334155; color: #94a3b8; }

        .fix-icon { animation: pulse-fix 1.5s infinite; cursor: pointer; }
        @keyframes pulse-fix { 0% { transform: scale(1); filter: drop-shadow(0 0 0px #ef4444); } 50% { transform: scale(1.2); filter: drop-shadow(0 0 5px #ef4444); } 100% { transform: scale(1); filter: drop-shadow(0 0 0px #ef4444); } }

        .drawer {
            position: fixed; top: 0; right: -650px; width: 650px; height: 100vh;
            background-color: #0f172a; border-left: 1px solid #334155;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100;
            box-shadow: -15px 0 30px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }

        .intent-mismatch { background-color: rgba(127, 29, 29, 0.1) !important; box-shadow: inset 3px 0 0 0 #ef4444; }

        /* Navigation Rail */
        .side-nav { position: fixed; left: 0; top: 0; bottom: 0; width: 54px; background: #020617; border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; padding-top: 1.5rem; gap: 1rem; z-index: 100; }
        .nav-item { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; color: #475569; transition: all 0.2s; position: relative; }
        .nav-item:hover { color: #94a3b8; background: #1e293b; }
        .nav-item.active { color: #10b981; background: #064e3b; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .nav-tooltip { visibility: hidden; position: absolute; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 15px; background: #1e293b; color: white; padding: 5px 10px; border-radius: 6px; font-size: 10px; white-space: nowrap; z-index: 200; border: 1px solid #334155; font-weight: 900; }
        .nav-item:hover .nav-tooltip { visibility: visible; }

        /* Full Screen Views */
        .view-content { display: none !important; height: 100vh; width: calc(100vw - 54px); margin-left: 54px; flex-direction: column; background-color: #020617; }
        .view-content.active { display: flex !important; }
        
        /* Tactical Components */
        .data-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 1.25rem; transition: all 0.2s; position: relative; }
        .data-card:hover { border-color: #334155; transform: translateY(-3px); }
        
        .memory-card.hot { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .memory-card.pinned { border-color: #f59e0b; border-width: 2px; }
        .memory-card.cold { opacity: 0.5; }

        .gantt-grid { display: grid; grid-template-columns: repeat(24, 1fr); gap: 2px; background: #020617; border: 1px solid #1e293b; padding: 4px; border-radius: 8px; }
        .gantt-cell { height: 40px; background: #0f172a; position: relative; border-right: 1px solid #1e293b/20; }
        .gantt-bar { position: absolute; height: 10px; border-radius: 5px; opacity: 0.8; transition: all 0.2s; }
        .gantt-bar:hover { opacity: 1; transform: scaleY(1.5); box-shadow: 0 0 10px white; z-index: 10; }

        .cursor-blink { border-right: 2px solid #10b981; animation: cursor-pulse 0.8s infinite; margin-left: 4px; }
        @keyframes cursor-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .toggle-label { display: flex; align-items: center; cursor: pointer; gap: 8px; }
        .toggle-box { width: 32px; height: 16px; background: #1e293b; border-radius: 10px; position: relative; transition: background 0.3s; }
        .toggle-circle { width: 12px; height: 12px; background: #475569; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s; }
        input:checked + .toggle-box { background: #064e3b; }
        input:checked + .toggle-box .toggle-circle { left: 18px; background: #10b981; }

        .anchor-highlight { background-color: rgba(16, 185, 129, 0.1) !important; box-shadow: inset 4px 0 0 0 #10b981; }
        [contenteditable]:hover { outline: 1px dashed #f59e0b; }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-mono h-screen flex overflow-hidden">
    <!-- Side Navigation -->
    <nav class="side-nav">
        <div class="nav-item active" onclick="switchView('operations')" id="nav-operations">
            <span class="text-xl">üì°</span><span class="nav-tooltip uppercase tracking-widest">Operations</span>
        </div>
        <div class="nav-item" onclick="switchView('knowledge')" id="nav-knowledge">
            <span class="text-xl">üß†</span><span class="nav-tooltip uppercase tracking-widest">Knowledge</span>
        </div>
        <div class="nav-item" onclick="switchView('automation')" id="nav-automation">
            <span class="text-xl">‚öôÔ∏è</span><span class="nav-tooltip uppercase tracking-widest">Automation</span>
        </div>
        <div class="nav-item" onclick="switchView('comms')" id="nav-comms">
            <span class="text-xl">üí¨</span><span class="nav-tooltip uppercase tracking-widest">Comms</span>
        </div>
        <div class="mt-auto mb-6 nav-item" onclick="switchView('system')" id="nav-system">
            <span class="text-xl">üõ†Ô∏è</span><span class="nav-tooltip uppercase tracking-widest">Registry</span>
        </div>
    </nav>

    <!-- VIEW: OPERATIONS (THE HOME) -->
    <main id="view-operations" class="view-content active p-4">
        <div class="w-full h-full flex flex-col">
            <header class="mb-4 flex justify-between items-center shrink-0 px-2">
                <div class="flex items-center gap-8">
                    <h1 class="text-xl font-bold flex items-center gap-3">
                        <img src="/assets/logo.png" class="h-6 w-6" alt="Logo" onerror="this.style.display='none'">
                        <span class="tracking-tighter uppercase"><span class="text-emerald-500">NanoClaw</span> <span class="text-slate-500">Tactical_5.0</span></span>
                    </h1>
                    <div class="relative">
                        <input type="text" id="search-box" placeholder="SEARCH_LOGS..." class="bg-slate-900 border border-slate-800 rounded px-3 py-1 text-[10px] w-48 focus:outline-none focus:border-emerald-500/50" oninput="renderCurrentData()">
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <label class="toggle-label">
                        <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Stream_Log</span>
                        <input type="checkbox" id="stream-toggle" class="hidden" onchange="toggleStream()">
                        <div class="toggle-box"><div class="toggle-circle"></div></div>
                    </label>
                    <div id="daily-stats" class="hidden md:flex gap-4 px-4 py-1.5 bg-slate-900/80 rounded border border-slate-800 text-[10px] font-bold tracking-tight">
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black">Tasks</span><span id="stat-tasks" class="text-emerald-400 font-mono">-</span></div>
                        <div class="w-px bg-slate-800 self-stretch"></div>
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black">Avg_Latency</span><span id="stat-latency" class="text-amber-400 font-mono">-</span></div>
                        <div class="w-px bg-slate-800 self-stretch"></div>
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black text-[8px]">TPS</span><span id="stat-tps" class="text-rose-400 font-mono">-</span></div>
                    </div>
                    <div id="status-indicator" class="text-[10px] text-slate-600 font-mono tracking-widest uppercase">Initializing...</div>
                </div>
            </header>
            <div class="flex-1 overflow-hidden bg-slate-900/50 rounded-md shadow-2xl border border-slate-800 flex flex-col">
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left text-[12px] border-collapse relative table-fixed">
                        <thead class="bg-slate-950 text-slate-500 uppercase text-[10px] sticky top-0 z-10 shadow-md">
                            <tr class="border-b border-slate-800">
                                <th class="px-3 py-2 w-[80px] font-black">Time</th>
                                <th class="px-3 py-2 w-[100px] font-black">Status</th>
                                <th class="px-3 py-2 w-[80px] font-black">Metrics</th>
                                <th class="px-3 py-2 w-[120px] font-black">Session</th>
                                <th class="px-3 py-2 w-[140px] font-black">Origin</th>
                                <th class="px-3 py-2 w-[20%] font-black">Question</th>
                                <th class="px-3 py-2 font-black">Answer / Tactical Actions</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
                <div class="shrink-0 bg-slate-950 border-t border-slate-800 px-4 py-2 flex justify-between items-center text-[10px] font-black uppercase tracking-widest">
                    <div class="flex items-center gap-4">
                        <button onclick="changePage(-1)" class="text-slate-500 hover:text-white">‚óÄ PREV</button>
                        <div class="text-slate-600">PAGE <span id="current-page-num" class="text-emerald-500">1</span></div>
                        <button onclick="changePage(1)" class="text-slate-500 hover:text-white">NEXT ‚ñ∂</button>
                    </div>
                    <div class="text-700">RECORDS: <span id="total-records-count">0</span></div>
                </div>
            </div>
        </div>
    </main>

    <!-- VIEW: KNOWLEDGE -->
    <main id="view-knowledge" class="view-content p-10 overflow-auto bg-slate-950">
        <div class="flex justify-between items-center mb-8 border-l-4 border-emerald-500 pl-4">
            <div>
                <h2 class="text-3xl font-black text-emerald-500 uppercase">üß† Knowledge_Base</h2>
                <p class="text-[10px] text-slate-500 font-bold tracking-widest">SYSTEM-WIDE PERSISTENT CONTEXT & FACTS</p>
            </div>
            <div class="flex gap-4">
                <button onclick="showAddMemoryForm()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1 rounded text-[10px] font-black uppercase tracking-widest transition-all">Add_Memory +</button>
                <div class="flex items-center gap-2 bg-slate-900/50 px-3 py-1 rounded border border-slate-800"><div class="w-2 h-2 rounded-full bg-f59e0b"></div><span class="text-[9px] font-black uppercase">Pinned</span></div>
                <div class="flex items-center gap-2 bg-slate-900/50 px-3 py-1 rounded border border-slate-800"><div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div><span class="text-[9px] font-black uppercase">Hot</span></div>
            </div>
        </div>

        <!-- Add Memory Form (Hidden by default) -->
        <div id="memory-form-container" class="hidden mb-8 bg-slate-900 p-6 rounded-xl border border-emerald-500/30 shadow-[0_0_20px_rgba(16,185,129,0.1)]">
            <h3 class="text-xs font-black text-emerald-500 uppercase mb-4 tracking-widest">New_Memory_Entry</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="text-[9px] text-slate-500 uppercase font-bold">Fact / Information</label>
                    <textarea id="new-memory-fact" class="bg-slate-950 border border-slate-800 rounded p-3 text-sm focus:outline-none focus:border-emerald-500 min-h-[100px]" placeholder="Enter fact here..."></textarea>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-[9px] text-slate-500 uppercase font-bold">Category</label>
                        <input type="text" id="new-memory-category" class="bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm focus:outline-none focus:border-emerald-500" placeholder="e.g. general, preference, contact">
                    </div>
                    <div class="flex justify-end gap-3 mt-auto">
                        <button onclick="hideAddMemoryForm()" class="px-4 py-2 text-[10px] font-bold text-slate-500 hover:text-white uppercase">Cancel</button>
                        <button onclick="submitNewMemory()" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-2 rounded text-[10px] font-black uppercase text-white shadow-lg shadow-emerald-900/20">Commit_Memory</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="memory-container"></div>
    </main>

    <!-- VIEW: AUTOMATION -->
    <main id="view-automation" class="view-content p-10 bg-slate-950 overflow-hidden">
        <div class="flex justify-between items-center mb-8 border-l-4 border-sky-500 pl-4 tracking-tighter">
            <h2 class="text-3xl font-black text-sky-500 uppercase">‚öôÔ∏è Automation_Grid</h2>
            <button onclick="showAddTaskForm()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-1 rounded text-[10px] font-black uppercase tracking-widest transition-all">New_Task +</button>
        </div>
        
        <div class="flex-1 flex flex-col gap-8 overflow-hidden">
            <!-- Add Task Form (Hidden) -->
            <div id="task-form-container" class="hidden shrink-0 bg-slate-900 p-6 rounded-xl border border-sky-500/30 shadow-[0_0_20px_rgba(14,165,233,0.1)] mb-4">
                <h3 class="text-xs font-black text-sky-500 uppercase mb-4 tracking-widest">Register_New_Task</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] text-slate-500 uppercase font-bold">Task_ID (Unique)</label>
                            <input type="text" id="new-task-id" class="bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-sky-400 focus:outline-none focus:border-sky-500" placeholder="e.g. gdp-monitor">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] text-slate-500 uppercase font-bold">Command_Prompt</label>
                            <textarea id="new-task-prompt" class="bg-slate-950 border border-slate-800 rounded p-3 text-sm focus:outline-none focus:border-sky-500 min-h-[80px]" placeholder="[SHELL: python3 ...]"></textarea>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col gap-2">
                                <label class="text-[9px] text-slate-500 uppercase font-bold">Schedule_Type</label>
                                <select id="new-task-type" class="bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm focus:outline-none focus:border-sky-500">
                                    <option value="cron">CRON (Linux style)</option>
                                    <option value="interval">INTERVAL (Seconds)</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-[9px] text-slate-500 uppercase font-bold">Schedule_Value</label>
                                <input type="text" id="new-task-value" class="bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm focus:outline-none focus:border-sky-500" placeholder="0 17 * * * / 3600">
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-6">
                            <button onclick="hideAddTaskForm()" class="px-4 py-2 text-[10px] font-bold text-slate-500 hover:text-white uppercase">Cancel</button>
                            <button onclick="submitNewTask()" class="bg-sky-600 hover:bg-sky-700 px-6 py-2 rounded text-[10px] font-black uppercase text-white">Deploy_Automation</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stability Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0" id="task-container"></div>
            
            <!-- 24H Gantt -->
            <div class="shrink-0 bg-slate-900/30 p-6 rounded-xl border border-slate-800/50">
                <div class="flex justify-between mb-4 text-[10px] font-black uppercase tracking-widest text-slate-500"><span>24H_Execution_Gantt</span><span>Load_Distribution</span></div>
                <div class="gantt-grid" id="gantt-container"></div>
                <div class="flex justify-between mt-2 px-1 text-[8px] text-slate-700 font-bold">${Array.from({length:24}).map((_,i)=>`<span>${i}h</span>`).join('')}</div>
            </div>

            <!-- Trace History -->
            <div class="flex-1 bg-slate-900/20 border border-slate-800 rounded-xl overflow-hidden flex flex-col">
                <div class="px-4 py-2 bg-slate-950 border-b border-slate-800 font-black text-[10px] uppercase text-slate-500">Trace_History</div>
                <div class="flex-1 overflow-auto" id="task-runs-container"></div>
            </div>
        </div>
    </main>

    <!-- VIEW: COMMS -->
    <main id="view-comms" class="view-content bg-slate-950">
        <div class="flex flex-row h-full">
            <div class="w-80 border-r border-slate-900 bg-slate-950/50 flex flex-col shrink-0">
                <div class="p-4 border-b border-slate-900 font-black text-[10px] uppercase text-slate-500 tracking-widest">Active_Nodes</div>
                <div class="flex-1 overflow-auto" id="chat-list"></div>
            </div>
            <div class="flex-1 flex flex-col">
                <div id="active-chat-header" class="px-8 py-6 border-b border-slate-900 bg-slate-950/80"></div>
                <div class="flex-1 overflow-auto p-10 space-y-6" id="message-container"></div>
            </div>
        </div>
    </main>

    <!-- VIEW: SYSTEM -->
    <main id="view-system" class="view-content p-10 overflow-auto bg-slate-950">
        <div class="flex justify-between items-center mb-8 border-l-4 border-slate-700 pl-4">
            <h2 class="text-3xl font-black text-slate-500 uppercase">üõ†Ô∏è System_Registry</h2>
            <span class="text-[9px] font-black bg-emerald-950/30 text-emerald-500 px-3 py-1 rounded border border-emerald-500/20 uppercase">Live_Edit_Enabled</span>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
            <table class="w-full text-left font-mono">
                <thead class="bg-slate-950 text-slate-500 uppercase text-[10px] font-black"><tr><th class="px-8 py-4">Registry_Key</th><th class="px-8 py-4">Assigned_Value</th></tr></thead>
                <tbody id="kv-container" class="divide-y divide-slate-800/50"></tbody>
            </table>
        </div>
    </main>

    <div id="drawer" class="drawer">
        <div class="p-4 border-b border-slate-800 flex justify-between bg-slate-950 items-center shadow-lg">
            <h2 class="text-sm font-black uppercase text-emerald-500" id="drawer-title">Metadata</h2>
            <button onclick="closeDrawer()" class="text-slate-500 hover:text-white transition-colors">‚úï CLOSE</button>
        </div>
        <div id="drawer-content" class="flex-1 overflow-auto p-8"></div>
    </div>

    <script>
        const statusIndicator = document.getElementById('status-indicator');
        const logBody = document.getElementById('log-body');
        const drawer = document.getElementById('drawer');
        const drawerContent = document.getElementById('drawer-content');
        const drawerTitle = document.getElementById('drawer-title');
        const searchBox = document.getElementById('search-box');

        const INTENT_KEYWORDS = ["Âèë", "Áîª", "ÁîüÊàê", "Êñá‰ª∂", "Âõæ", "ËØ≠Èü≥", "Êí≠Êä•", "send", "generate", "image", "voice"];
        const ACTION_TYPES = ["File", "Image", "Audio"];

        let lastData = { log: [], stats: null, total: 0 };
        let currentPage = 1;
        let currentActiveView = 'operations';
        let streamTimer = null;

        function toggleStream() {
            const isEnabled = document.getElementById('stream-toggle').checked;
            clearInterval(streamTimer);
            if (isEnabled) { streamTimer = setInterval(fetchLog, 800); statusIndicator.textContent = 'STREAMING_ACTIVE'; }
            else { streamTimer = setInterval(fetchLog, 3000); statusIndicator.textContent = 'SYNCED'; }
        }

        function switchView(viewName, anchorKey = null) {
            currentActiveView = viewName;
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            document.getElementById(`nav-${viewName}`).classList.add('active');
            
            if (viewName === 'knowledge') fetchMemories();
            else if (viewName === 'automation') fetchAutomation();
            else if (viewName === 'comms') fetchChats();
            else if (viewName === 'system') fetchKV(anchorKey);
            else if (viewName === 'operations') fetchLog();
        }

        async function fetchLog() {
            if (currentActiveView !== 'operations') return;
            try {
                const res = await fetch(`/api/log?page=${currentPage}&limit=20`);
                lastData = await res.json();
                renderCurrentData();
                if (lastData.stats) {
                    document.getElementById('stat-tasks').textContent = lastData.stats.total_tasks;
                    document.getElementById('stat-latency').textContent = (lastData.stats.avg_duration/1000).toFixed(1) + 's';
                    const resolved = lastData.log.filter(t => t.status === 'RESOLVED' && t.token_usage && t.duration_ms > 0);
                    if (resolved.length > 0) {
                        const tokens = resolved.reduce((s, t) => s + t.token_usage.completion, 0);
                        const ms = resolved.reduce((s, t) => s + t.duration_ms, 0);
                        document.getElementById('stat-tps').textContent = (tokens / (ms / 1000)).toFixed(1);
                    }
                }
                document.getElementById('current-page-num').textContent = currentPage;
                document.getElementById('total-records-count').textContent = lastData.total;
            } catch (e) { statusIndicator.innerHTML = `<span class="text-red-500">OFFLINE</span>`; }
        }

        function renderCurrentData() {
            const query = searchBox.value.toLowerCase();
            logBody.innerHTML = lastData.log.filter(t => t.content.toLowerCase().includes(query)).map(t => {
                const hasWarning = t.status === 'RESOLVED' && checkIntentWarning(t.content, t.responses);
                const isStreaming = t.status === 'PENDING' && document.getElementById('stream-toggle').checked;
                return `<tr class="hover:bg-slate-800/40 group transition-colors ${hasWarning ? 'intent-mismatch' : ''}">
                    <td class="px-3 py-3 align-top"><div class="flex flex-col"><span class="text-slate-600 font-bold text-[10px]">${formatTime(t.created_at)}</span><span class="text-[8px] text-slate-700 font-mono mt-1 cursor-pointer hover:text-emerald-500" onclick="openTaskInspector('${t.id}')">#${t.id.slice(0,8)}</span></div></td>
                    <td class="px-3 py-3 align-top">${getStatusBadge(t.status, hasWarning, t.id)}</td>
                    <td class="px-3 py-3 align-top">${getDurationBadge(t.duration_ms, t.token_usage, hasWarning, t.telemetry)}</td>
                    <td class="px-3 py-3 align-top">${renderSession(t.session_id)}</td>
                    <td class="px-3 py-3 align-top font-mono text-[10px] text-slate-500">${t.origin_ip || 'LOCAL'}</td>
                    <td class="px-3 py-3 align-top text-slate-300 w-[20%] text-[11px]">${renderQuestion(t.content)}</td>
                    <td class="px-3 py-3 align-top w-[60%]">${renderResponses(t.responses, t.attachments, t.id, t.created_at, isStreaming)}</td>
                </tr>`;
            }).join('');
        }

        async function fetchMemories() {
            const res = await fetch('/api/memories');
            const data = await res.json();
            data.sort((a, b) => (b.is_pinned - a.is_pinned) || new Date(b.created_at) - new Date(a.created_at));
            document.getElementById('memory-container').innerHTML = data.map(m => {
                const isHot = m.ref_count > 10;
                const cardClass = `memory-card data-card ${m.is_pinned ? 'pinned' : ''} ${isHot ? 'hot' : ''}`;
                return `<div class="${cardClass}">
                    <div class="flex justify-between mb-3 text-[9px] font-black uppercase text-slate-500">
                        <span class="bg-emerald-950/50 text-emerald-400 px-1.5 py-0.5 rounded border border-emerald-500/20">${m.category}</span>
                        <div class="flex gap-2"><span>${m.ref_count} REFS</span><span>${formatTime(m.created_at)}</span></div>
                    </div>
                    ${m.is_pinned ? '<div class="text-[8px] text-amber-500 font-black uppercase mb-2">üìå Core_Directive</div>' : ''}
                    <p class="text-[13px] italic text-slate-200 outline-none leading-relaxed font-serif" contenteditable="true" onblur="updateMemoryFact(${m.id}, this)">"${m.fact}"</p>
                    <div class="mt-4 flex justify-between opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex gap-3">
                            <button onclick="switchView('comms'); fetchMessages('${m.chat_jid}', '${m.chat_jid}')" class="text-[9px] text-sky-500 font-bold hover:text-white">Ê∫ØÊ∫ê üîç</button>
                            <button onclick="togglePin(${m.id}, '${m.fact}', '${m.category}', ${m.is_pinned})" class="text-[9px] ${m.is_pinned ? 'text-amber-500' : 'text-slate-600'} font-bold">ÁΩÆÈ°∂</button>
                        </div>
                        <button onclick="deleteMemory(${m.id})" class="text-[9px] text-rose-600 font-bold">ÂõûÊî∂</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function fetchAutomation() {
            const res = await fetch('/api/tasks');
            const data = await res.json();
            const { tasks, runs } = data;
            
            document.getElementById('task-container').innerHTML = tasks.map(t => {
                const taskRuns = runs.filter(r => r.task_id === t.id).slice(0, 10);
                const hasRuns = taskRuns.length > 0;
                const successRate = hasRuns ? (taskRuns.filter(r => r.status === 'success').length / taskRuns.length * 100).toFixed(0) : null;
                const stabilityText = hasRuns ? `${successRate}% STABLE` : 'WAITING_FIRST_RUN';
                const borderColor = !hasRuns ? 'border-slate-700' : (successRate > 90 ? 'border-emerald-500' : 'border-rose-500');
                
                return `<div class="data-card border-l-4 ${borderColor} cursor-pointer hover:bg-slate-900/50" onclick="openAutomationTaskInspector('${t.id}')">
                    <div class="flex justify-between mb-3 text-[9px] font-black">
                        <span class="text-slate-500 uppercase">${t.status}</span>
                        <span class="${!hasRuns ? 'text-slate-600' : (successRate > 90 ? 'text-emerald-500' : 'text-rose-500')} animate-pulse">${stabilityText}</span>
                    </div>
                    <div class="text-[11px] font-bold text-slate-300 truncate">${t.id}</div>
                    <p class="text-xs text-slate-500 italic mt-2 line-clamp-2">"${t.prompt}"</p>
                    <div class="mt-3 text-[8px] text-slate-600 font-bold uppercase tracking-tighter">NEXT_RUN: ${t.next_run ? formatDateTime(t.next_run) : 'MANUAL_ONLY'}</div>
                </div>`;
            }).join('');

            const ganttContainer = document.getElementById('gantt-container');
            ganttContainer.innerHTML = Array.from({length: 24}).map((_, h) => {
                const hourRuns = runs.filter(r => new Date(r.run_at).getHours() === h);
                return `<div class="gantt-cell">
                    ${hourRuns.map(r => {
                        const m = new Date(r.run_at).getMinutes();
                        const color = r.status === 'success' ? 'bg-sky-500' : 'bg-rose-500';
                        return `<div class="gantt-bar ${color} w-1" style="left: ${(m/60)*100}%" title="${r.task_id} @ ${formatDateTime(r.run_at)}"></div>`;
                    }).join('')}
                </div>`;
            }).join('');

            document.getElementById('task-runs-container').innerHTML = `<table class="w-full text-[10px] divide-y divide-slate-800/50">
                <thead class="bg-slate-950 text-slate-600 uppercase text-[8px] font-black sticky top-0"><tr><th class="p-2 text-left">Timestamp</th><th class="p-2 text-left">Task</th><th class="p-2 text-left">Status</th><th class="p-2 text-left">Trace</th></tr></thead>
                <tbody>${runs.map(r => `<tr><td class="p-2 font-mono text-slate-500">${formatDateTime(r.run_at)}</td><td class="p-2 text-slate-400">#${r.task_id.slice(0,8)}</td><td class="p-2 font-black ${r.status === 'success' ? 'text-emerald-500' : 'text-rose-500'}">${r.status.toUpperCase()}</td><td class="p-2 truncate max-w-lg text-slate-500">${r.result || r.error}</td></tr>`).join('')}</tbody>
            </table>`;
        }

        async function fetchChats() {
            const res = await fetch('/api/chats');
            const data = await res.json();
            document.getElementById('chat-list').innerHTML = data.map(c => `
                <div class="p-5 border-b border-slate-900 hover:bg-slate-900/50 cursor-pointer group" onclick="fetchMessages('${c.jid}', '${c.name || c.jid}')">
                    <div class="flex justify-between text-xs font-bold text-slate-300">
                        <div class="flex items-center gap-2"><span>${c.jid.includes('@s.whatsapp') ? 'üì±' : 'üê¶'}</span><span>${c.name || 'Unknown'}</span></div>
                        <span class="text-[8px] text-slate-600">${formatTime(c.last_message_time)}</span>
                    </div>
                    <div class="mt-2 flex gap-0.5 h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                        ${Array.from({length:12}).map(()=>`<div class="flex-1 bg-indigo-500/${Math.random() > 0.5 ? '40' : '10'}"></div>`).join('')}
                    </div>
                </div>`).join('');
        }

        async function fetchMessages(jid, name) {
            document.getElementById('active-chat-header').innerHTML = `<div class="flex items-center justify-between w-full"><div class="text-sm font-bold text-emerald-500 uppercase">${name}</div><button onclick="switchView('operations')" class="text-[9px] bg-slate-900 px-2 py-1 rounded border border-slate-800 hover:text-white">AUDIT_LOG üì°</button></div>`;
            const res = await fetch(`/api/messages/${encodeURIComponent(jid)}`);
            const data = await res.json();
            document.getElementById('message-container').innerHTML = data.map(m => `<div class="flex ${m.from_me ? 'justify-end' : 'justify-start'}"><div class="max-w-[75%] ${m.from_me ? 'bg-emerald-950/20 border-emerald-900/50' : 'bg-slate-900 border-slate-800'} border p-4 rounded-2xl text-sm text-slate-300 relative group">${m.content}<div class="text-[8px] text-slate-600 mt-2 text-right">${formatTime(m.timestamp)}</div></div></div>`).join('');
            document.getElementById('message-container').scrollTop = document.getElementById('message-container').scrollHeight;
        }

        async function fetchKV(anchorKey = null) {
            const res = await fetch('/api/kv');
            const data = await res.json();
            document.getElementById('kv-container').innerHTML = data.map(kv => `<tr class="hover:bg-slate-900/30 transition-colors ${anchorKey === kv.key ? 'anchor-highlight' : ''}" id="kv-row-${kv.key}"><td class="px-8 py-4 font-black text-slate-500 uppercase text-xs">${kv.key}</td><td class="px-8 py-4 text-emerald-500 font-bold outline-none" contenteditable="true" onblur="updateKV('${kv.key}', this)">${kv.value}</td></tr>`).join('');
            if (anchorKey) document.getElementById(`kv-row-${anchorKey}`)?.scrollIntoView({ behavior: 'smooth' });
        }

        async function updateKV(key, el) { await fetch(`/api/kv/${encodeURIComponent(key)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ value: el.innerText }) }); statusIndicator.textContent = 'REGISTRY_UPDATED'; }
        
        function showAddMemoryForm() { document.getElementById('memory-form-container').classList.remove('hidden'); }
        function hideAddMemoryForm() { document.getElementById('memory-form-container').classList.add('hidden'); }
        async function submitNewMemory() {
            const fact = document.getElementById('new-memory-fact').value;
            const category = document.getElementById('new-memory-category').value || 'general';
            if (!fact) return alert('FACT_REQUIRED');
            await fetch('/api/memories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fact, category })
            });
            document.getElementById('new-memory-fact').value = '';
            hideAddMemoryForm();
            fetchMemories();
            statusIndicator.textContent = 'MEMORY_STORED';
        }

        async function updateMemoryFact(id, el) { await fetch(`/api/memories/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fact: el.innerText.replace(/^"|"$/g, '') }) }); statusIndicator.textContent = 'MEMORY_UPDATED'; }
        async function togglePin(id, fact, cat, pin) { await fetch(`/api/memories/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fact, category: cat, is_pinned: !pin }) }); fetchMemories(); }
        async function deleteMemory(id) { if (confirm('RECYCLE?')) { await fetch(`/api/memories/${id}`, { method: 'DELETE' }); fetchMemories(); } }

        function formatTime(iso) { return new Date(iso).toLocaleTimeString('zh-CN', { hour12: false }); }
        function formatDateTime(iso) { 
            const d = new Date(iso);
            const date = (d.getMonth() + 1).toString().padStart(2, '0') + '-' + d.getDate().toString().padStart(2, '0');
            const time = d.toLocaleTimeString('zh-CN', { hour12: false });
            return `${date} ${time}`;
        }
        function closeDrawer() { drawer.classList.remove('open'); }
        function changePage(delta) { currentPage = Math.max(1, currentPage + delta); fetchLog(); }
        function checkIntentWarning(q, r) { if (!INTENT_KEYWORDS.some(kw => q.toLowerCase().includes(kw))) return false; return !r || !r.some(res => ACTION_TYPES.includes(res.type)); }

        function getStatusBadge(s, w, id) {
            let cls = s === 'PENDING' ? 'bg-amber-950/50 text-amber-400 border-amber-800/50' : (w ? 'bg-red-950 text-white border-red-500 animate-pulse' : 'bg-emerald-950/50 text-emerald-400 border-emerald-800/50');
            return `<div class="flex flex-col gap-1 items-center w-full"><div class="px-2 py-0.5 rounded border ${cls} text-[9px] font-black text-center w-full uppercase tracking-widest">${s === 'PENDING' ? 'RUN' : (w ? 'MISSING' : 'DONE')}</div><button onclick="triggerFix('${id}', this)" class="text-[8px] text-rose-400 hover:text-white uppercase font-bold">üîß FIX</button><button onclick="retryTask('${id}', this)" class="text-[8px] text-slate-600 hover:text-white uppercase font-bold">‚Ü∫ RETRY</button></div>`;
        }

        function getDurationBadge(ms, usage, w, tel) {
            if (!ms) return '-';
            let bar = ''; if (usage && usage.total > 0) { const p = (usage.prompt/usage.total)*100; bar = `<div class="flex w-full h-1 bg-slate-800 rounded-full mt-1 overflow-hidden cursor-pointer hover:ring-1 ring-white/30" title="Á©øÈÄèËá≥Ê≥®ÂÜåË°®" onclick="switchView('system', 'LAST_GROUP_SYNC')"><div class="bg-emerald-500 h-full" style="width: ${p}%"></div><div class="bg-blue-500 h-full" style="width: ${100-p}%"></div></div>`; }
            return `<div class="flex flex-col w-full"><span class="text-[11px] font-bold ${ms > 15000 ? 'text-amber-400' : 'text-emerald-400'} cursor-help" onclick="openPerformanceWaterfall('${btoa(JSON.stringify(tel))}', ${ms})">${(ms/1000).toFixed(1)}s</span><span class="text-[8px] text-slate-600 mt-0.5">${usage ? (usage.total/1000).toFixed(1)+'k' : '-'} tok</span>${bar}</div>`;
        }

        function renderResponses(rs, att, pid, st, isStreaming) {
            if ((!rs || rs.length === 0) && !isStreaming) return '<span class="text-slate-700 italic text-[10px]">Thinking...</span>';
            const bt = new Date(st).getTime();
            let html = `<div class="space-y-1">${rs.map(r => {
                const d = ((new Date(r.created_at).getTime() - bt) / 1000).toFixed(1);
                let b = r.content.startsWith('[Status]') ? 'STEP' : (r.type === 'Image' ? 'VISUAL' : (r.type === 'File' ? 'FILE' : (r.type === 'Audio' ? 'VOICE' : '')));
                let c = r.content.startsWith('[Status]') ? r.content.replace('[Status]', '').trim() : r.content;
                return `<div class="flex justify-between items-start gap-2 group/node"><div class="text-[11px] text-slate-400 line-clamp-1 hover:line-clamp-none cursor-pointer flex-1">${b ? `<span class="text-[8px] bg-slate-800 px-1 rounded mr-1">${b}</span>` : ''}<span>${c}</span></div><span class="text-[8px] text-slate-700 opacity-0 group-hover/node:opacity-100 transition-opacity font-mono">+${d}s</span></div>`;
            }).join('')}`;
            if (isStreaming) html += `<div class="text-emerald-500 text-[11px] flex items-center gap-1 italic">Thinking... <span class="cursor-blink">‚ñã</span></div>`;
            return html + '</div>';
        }

        function renderQuestion(q) { if (!q) return ''; return q.replace(/</g, '&lt;').replace(/\[IMAGE: (.*?)\]/g, '<span class="bg-purple-950/50 text-purple-400 text-[8px] px-1 rounded border border-purple-500/30 mr-1">IMG</span>'); }
        function renderSession(sid) { return `<div class="text-[11px] font-bold text-sky-400 truncate cursor-pointer hover:underline" onclick="switchView('comms'); fetchMessages('${sid}', '${sid}')">${sid.slice(0,4)}...${sid.slice(-4)}</div>`; }

        function openPerformanceWaterfall(b, t) {
            if (!b || b === 'bnVsbA==') return;
            const tel = JSON.parse(atob(b));
            drawerTitle.textContent = 'ÊÄßËÉΩÁªÜÂàÜ';
            const p = (v) => ((v/t)*100).toFixed(1)+'%';
            drawerContent.innerHTML = `<div class="bg-slate-900 p-6 rounded-xl border border-slate-800"><div class="flex justify-between text-[10px] font-black mb-4 uppercase"><span>Timeline</span><span>${(t/1000).toFixed(2)}s</span></div><div class="flex h-6 bg-slate-950 rounded-full overflow-hidden border border-slate-800 p-1 gap-1"><div class="perf-pre h-full" style="width: ${p(tel.pre)}"></div><div class="perf-llm h-full" style="width: ${p(tel.llm)}"></div><div class="perf-post h-full" style="width: ${p(tel.post)}"></div></div><div class="grid grid-cols-3 mt-6 text-[10px]"><div class="border-l border-emerald-500/30 pl-2">È¢ÑÂ§ÑÁêÜ<div>${(tel.pre/1000).toFixed(2)}s</div></div><div class="border-l border-blue-500/30 pl-2">Ê®°ÂûãÊé®ÁêÜ<div>${(tel.llm/1000).toFixed(2)}s</div></div><div class="border-l border-amber-500/30 pl-2">Â∑•ÂÖ∑ÊâßË°å<div>${(tel.post/1000).toFixed(2)}s</div></div></div></div>`;
            drawer.classList.add('open');
        }

        function openTaskInspector(id) {
            const t = lastData.log.find(x => x.id === id);
            drawerTitle.textContent = `Inspector: ${id.slice(0,8)}`;
            drawerContent.innerHTML = `<div class="space-y-6"><section><h3 class="text-[10px] text-slate-500 uppercase font-black border-l-2 border-emerald-500 pl-2 mb-2">Payload</h3><div class="bg-slate-950 p-4 rounded border border-slate-800 font-mono text-xs whitespace-pre-wrap">${t.content}</div></section><section><h3 class="text-[10px] text-slate-500 uppercase font-black border-l-2 border-blue-500 pl-2 mb-2">Usage</h3><div class="grid grid-cols-3 gap-2">${['prompt','completion','total'].map(k => `<div class="bg-slate-900 p-3 rounded border border-slate-800 text-center"><div class="text-[8px] text-slate-600 uppercase">${k}</div><div class="text-sm font-bold text-slate-300">${t.token_usage?.[k] || 0}</div></div>`).join('')}</div></section></div>`;
            drawer.classList.add('open');
        }

        function showAddTaskForm() { document.getElementById('task-form-container').classList.remove('hidden'); }
        function hideAddTaskForm() { document.getElementById('task-form-container').classList.add('hidden'); }
        async function submitNewTask() {
            const id = document.getElementById('new-task-id').value;
            const prompt = document.getElementById('new-task-prompt').value;
            const schedule_type = document.getElementById('new-task-type').value;
            const schedule_value = document.getElementById('new-task-value').value;
            if (!prompt || !schedule_value) return alert('FIELDS_REQUIRED');
            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, prompt, schedule_type, schedule_value })
            });
            hideAddTaskForm();
            fetchAutomation();
            statusIndicator.textContent = 'TASK_DEPLOYED';
        }

        async function updateTaskStatus(id, newStatus) {
            await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            fetchAutomation();
            openAutomationTaskInspector(id); // Refresh drawer
        }

        async function updateTaskConfig(id, updates) {
            // Clean up quotes if user left them in prompt
            if (updates.prompt) updates.prompt = updates.prompt.replace(/^"|"$/g, '');
            
            await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            statusIndicator.textContent = 'TASK_CONFIG_UPDATED';
            fetchAutomation();
        }

        async function deleteTask(id) {
            if (confirm(`DELETE_TASK: ${id}?`)) {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                closeDrawer();
                fetchAutomation();
            }
        }

        async function openAutomationTaskInspector(id) {
            const res = await fetch('/api/tasks');
            const { tasks, runs } = await res.json();
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            const taskRuns = runs.filter(r => r.task_id === id);

            drawerTitle.textContent = `Automation_Inspector: ${id.slice(0,8)}`;
            drawerContent.innerHTML = `
                <div class="space-y-8">
                    <section>
                        <div class="flex justify-between items-center mb-4 border-l-2 border-sky-500 pl-2">
                            <h3 class="text-[10px] text-slate-500 uppercase font-black">Task_Configuration</h3>
                            <div class="flex gap-2">
                                <button onclick="updateTaskStatus('${t.id}', '${t.status === 'active' ? 'paused' : 'active'}')" class="text-[8px] font-black px-2 py-1 rounded border ${t.status === 'active' ? 'border-amber-500 text-amber-500' : 'border-emerald-500 text-emerald-500'} uppercase">${t.status === 'active' ? 'Pause' : 'Resume'}</button>
                                <button onclick="deleteTask('${t.id}')" class="text-[8px] font-black px-2 py-1 rounded border border-rose-500 text-rose-500 uppercase">Delete</button>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-800 space-y-4">
                            <div>
                                <div class="text-[8px] text-slate-600 uppercase font-black mb-1">Command_Prompt (Click to Edit)</div>
                                <div class="text-sm italic text-slate-300 outline-none border-b border-transparent focus:border-sky-500/50 pb-1" contenteditable="true" onblur="updateTaskConfig('${t.id}', { prompt: this.innerText })">"${t.prompt}"</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[8px] text-slate-600 uppercase font-black mb-1">Schedule (${t.schedule_type})</div>
                                    <div class="text-xs font-mono text-sky-400 outline-none border-b border-transparent focus:border-sky-500/50" contenteditable="true" onblur="updateTaskConfig('${t.id}', { schedule_value: this.innerText })">${t.schedule_value}</div>
                                </div>
                                <div><div class="text-[8px] text-slate-600 uppercase font-black mb-1">Status</div><div class="text-xs font-mono ${t.status === 'active' ? 'text-emerald-500' : 'text-amber-500'}">${t.status.toUpperCase()}</div></div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-[10px] text-slate-500 uppercase font-black border-l-2 border-amber-500 pl-2 mb-4">Execution_History</h3>
                        <div class="space-y-2">
                            ${taskRuns.length > 0 ? taskRuns.map(r => `
                                <div class="bg-slate-900/30 p-3 rounded border border-slate-800 flex justify-between items-center">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] font-mono text-slate-400">${formatDateTime(r.run_at)}</span>
                                        <span class="text-[9px] text-slate-600 uppercase font-black">${r.duration_ms ? (r.duration_ms/1000).toFixed(1)+'s' : '-'} Duration</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-[9px] font-black ${r.status === 'success' ? 'text-emerald-500' : 'text-rose-500'}">${r.status.toUpperCase()}</span>
                                        <button onclick="alert('${(r.result || r.error || 'NO_TRACE').replace(/'/g, "\\'")}')" class="text-slate-700 hover:text-white text-xs">üîç</button>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center py-8 text-slate-700 text-[10px] uppercase font-black tracking-widest border border-dashed border-slate-800 rounded-xl">No_Execution_Logs_Found</div>'}
                        </div>
                    </section>
                </div>
            `;
            drawer.classList.add('open');
        }

        setInterval(fetchLog, 3000); fetchLog();
    </script>
</body>
</html>