<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoClaw Tactical Terminal 5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes breathe { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.95); } }
        .status-breathe { animation: breathe 2s ease-in-out infinite; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .perf-node { height: 4px; border-radius: 2px; }
        .perf-pre { background-color: #10b981; }
        .perf-llm { background-color: #3b82f6; }
        .perf-post { background-color: #f59e0b; }
        
        .intent-tag { font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: 900; text-transform: uppercase; }
        .tag-visual_gen { background-color: #7e22ce; color: white; }
        .tag-data_analysis { background-color: #0369a1; color: white; }
        .tag-voice_gen { background-color: #be123c; color: white; }
        .tag-doc_summary { background-color: #15803d; color: white; }
        .tag-general { background-color: #334155; color: #94a3b8; }

        .fix-icon { animation: pulse-fix 1.5s infinite; cursor: pointer; }
        @keyframes pulse-fix { 0% { transform: scale(1); filter: drop-shadow(0 0 0px #ef4444); } 50% { transform: scale(1.2); filter: drop-shadow(0 0 5px #ef4444); } 100% { transform: scale(1); filter: drop-shadow(0 0 0px #ef4444); } }

        .drawer {
            position: fixed; top: 0; right: -650px; width: 650px; height: 100vh;
            background-color: #0f172a; border-left: 1px solid #334155;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100;
            box-shadow: -15px 0 30px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }

        .intent-mismatch { background-color: rgba(127, 29, 29, 0.1) !important; box-shadow: inset 3px 0 0 0 #ef4444; }

        /* Navigation Rail */
        .side-nav { position: fixed; left: 0; top: 0; bottom: 0; width: 54px; background: #020617; border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; padding-top: 1.5rem; gap: 1rem; z-index: 100; }
        .nav-item { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; color: #475569; transition: all 0.2s; position: relative; }
        .nav-item:hover { color: #94a3b8; background: #1e293b; }
        .nav-item.active { color: #10b981; background: #064e3b; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .nav-tooltip { visibility: hidden; position: absolute; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 15px; background: #1e293b; color: white; padding: 5px 10px; border-radius: 6px; font-size: 10px; white-space: nowrap; z-index: 200; border: 1px solid #334155; font-weight: 900; }
        .nav-item:hover .nav-tooltip { visibility: visible; }

        /* Full Screen Switching (CRITICAL FIX) */
        .view-content { display: none !important; height: 100vh; width: calc(100vw - 54px); margin-left: 54px; flex-direction: column; background-color: #020617; }
        .view-content.active { display: flex !important; }
        
        .data-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 1.25rem; }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-mono h-screen flex overflow-hidden">
    <!-- Fixed Side Navigation -->
    <nav class="side-nav">
        <div class="nav-item active" onclick="switchView('operations')" id="nav-operations">
            <span class="text-xl">üì°</span><span class="nav-tooltip uppercase tracking-widest">Operations</span>
        </div>
        <div class="nav-item" onclick="switchView('knowledge')" id="nav-knowledge">
            <span class="text-xl">üß†</span><span class="nav-tooltip uppercase tracking-widest">Memory</span>
        </div>
        <div class="nav-item" onclick="switchView('automation')" id="nav-automation">
            <span class="text-xl">‚öôÔ∏è</span><span class="nav-tooltip uppercase tracking-widest">Tasks</span>
        </div>
        <div class="nav-item" onclick="switchView('comms')" id="nav-comms">
            <span class="text-xl">üí¨</span><span class="nav-tooltip uppercase tracking-widest">Comms</span>
        </div>
        <div class="mt-auto mb-6 nav-item" onclick="switchView('system')" id="nav-system">
            <span class="text-xl">üõ†Ô∏è</span><span class="nav-tooltip uppercase tracking-widest">Registry</span>
        </div>
    </nav>

    <!-- VIEW: OPERATIONS -->
    <main id="view-operations" class="view-content active p-4">
        <div class="w-full h-full flex flex-col">
            <header class="mb-4 flex justify-between items-center shrink-0 px-2">
                <div class="flex items-center gap-8">
                    <h1 class="text-xl font-bold flex items-center gap-3">
                        <img src="/assets/logo.png" class="h-6 w-6" alt="Logo" onerror="this.style.display='none'">
                        <span class="tracking-tighter uppercase"><span class="text-emerald-500">NanoClaw</span> <span class="text-slate-500">Tactical_5.0</span></span>
                    </h1>
                    <div id="heatmap-container" class="hidden lg:flex gap-2 bg-slate-900/50 p-1 px-3 rounded border border-slate-800"></div>
                    <div class="relative">
                        <input type="text" id="search-box" placeholder="SEARCH_LOGS..." class="bg-slate-900 border border-slate-800 rounded px-3 py-1 text-[10px] w-48 focus:outline-none focus:border-emerald-500/50" oninput="renderCurrentData()">
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div id="daily-stats" class="hidden md:flex gap-4 px-4 py-1.5 bg-slate-900/80 rounded border border-slate-800 text-[10px] font-bold tracking-tight">
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black">Tasks</span><span id="stat-tasks" class="text-emerald-400 font-mono">-</span></div>
                        <div class="w-px bg-slate-800 self-stretch"></div>
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black">Latency</span><span id="stat-latency" class="text-amber-400 font-mono">-</span></div>
                        <div class="w-px bg-slate-800 self-stretch"></div>
                        <div class="flex flex-col text-center"><span class="text-slate-500 uppercase font-black">TPS</span><span id="stat-tps" class="text-rose-400 font-mono">-</span></div>
                    </div>
                    <div id="status-indicator" class="text-[10px] text-slate-600 font-mono tracking-widest uppercase">Initializing...</div>
                </div>
            </header>
            <div class="flex-1 overflow-hidden bg-slate-900/50 rounded-md shadow-2xl border border-slate-800 flex flex-col">
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left text-[12px] border-collapse relative table-fixed">
                        <thead class="bg-slate-950 text-slate-500 uppercase text-[10px] sticky top-0 z-10 shadow-md">
                            <tr class="border-b border-slate-800">
                                <th class="px-3 py-2 w-[80px] font-black">Time</th>
                                <th class="px-3 py-2 w-[100px] font-black">Status</th>
                                <th class="px-3 py-2 w-[80px] font-black">Metrics</th>
                                <th class="px-3 py-2 w-[120px] font-black">Session</th>
                                <th class="px-3 py-2 w-[140px] font-black">Origin</th>
                                <th class="px-3 py-2 w-[20%] font-black">Question</th>
                                <th class="px-3 py-2 font-black">Answer / Tactical Actions</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
                <div class="shrink-0 bg-slate-950 border-t border-slate-800 px-4 py-2 flex justify-between items-center text-[10px] font-black uppercase tracking-widest">
                    <div class="flex items-center gap-4">
                        <button onclick="changePage(-1)" class="text-slate-500 hover:text-white">‚óÄ PREV</button>
                        <div class="text-slate-600">PAGE <span id="current-page-num" class="text-emerald-500">1</span></div>
                        <button onclick="changePage(1)" class="text-slate-500 hover:text-white">NEXT ‚ñ∂</button>
                    </div>
                    <div class="text-700">RECORDS: <span id="total-records-count">0</span></div>
                </div>
            </div>
        </div>
    </main>

    <!-- VIEW: KNOWLEDGE -->
    <main id="view-knowledge" class="view-content p-10 overflow-auto">
        <h2 class="text-3xl font-black text-emerald-500 uppercase mb-8 tracking-tighter">üß† Knowledge_Base</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="memory-container"></div>
    </main>

    <!-- VIEW: AUTOMATION -->
    <main id="view-automation" class="view-content p-10">
        <h2 class="text-3xl font-black text-sky-500 uppercase mb-8 tracking-tighter">‚öôÔ∏è Automation_Grid</h2>
        <div class="flex flex-col gap-8 h-full overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-1/3 overflow-auto shrink-0" id="task-container"></div>
            <div class="flex-1 bg-slate-900/30 border border-slate-800 rounded-xl overflow-hidden flex flex-col">
                <div class="px-4 py-2 bg-slate-950 border-b border-slate-800 font-black text-[10px] uppercase text-slate-500">History</div>
                <div class="flex-1 overflow-auto" id="task-runs-container"></div>
            </div>
        </div>
    </main>

    <!-- VIEW: COMMS -->
    <main id="view-comms" class="view-content">
        <div class="flex flex-row h-full">
            <div class="w-80 border-r border-slate-900 bg-slate-950/50 flex flex-col shrink-0">
                <div class="p-4 border-b border-slate-900 font-black text-[10px] uppercase text-slate-500">Sessions</div>
                <div class="flex-1 overflow-auto" id="chat-list"></div>
            </div>
            <div class="flex-1 flex flex-col bg-slate-900/10">
                <div id="active-chat-header" class="px-8 py-6 border-b border-slate-900 bg-slate-950/80"></div>
                <div class="flex-1 overflow-auto p-10 space-y-6" id="message-container"></div>
            </div>
        </div>
    </main>

    <!-- VIEW: SYSTEM -->
    <main id="view-system" class="view-content p-10 overflow-auto">
        <h2 class="text-3xl font-black text-slate-500 uppercase mb-8 tracking-tighter">üõ†Ô∏è System_Registry</h2>
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full text-left font-mono"><tbody id="kv-container" class="divide-y divide-slate-800/50"></tbody></table>
        </div>
    </main>

    <!-- Drawer -->
    <div id="drawer" class="drawer">
        <div class="p-4 border-b border-slate-800 flex justify-between bg-slate-950 items-center">
            <h2 class="text-sm font-black uppercase text-emerald-500" id="drawer-title">Metadata</h2>
            <button onclick="closeDrawer()">‚úï CLOSE</button>
        </div>
        <div id="drawer-content" class="flex-1 overflow-auto p-8"></div>
    </div>

    <script>
        const statusIndicator = document.getElementById('status-indicator');
        const logBody = document.getElementById('log-body');
        const drawer = document.getElementById('drawer');
        const drawerContent = document.getElementById('drawer-content');
        const drawerTitle = document.getElementById('drawer-title');
        const searchBox = document.getElementById('search-box');

        const INTENT_KEYWORDS = ["Âèë", "Áîª", "ÁîüÊàê", "Êñá‰ª∂", "Âõæ", "ËØ≠Èü≥", "Êí≠Êä•", "send", "generate", "image", "voice"];
        const ACTION_TYPES = ["File", "Image", "Audio"];

        let lastData = { log: [], stats: null, total: 0 };
        let currentPage = 1;
        let currentActiveView = 'operations';

        function switchView(viewName) {
            currentActiveView = viewName;
            // First hide all
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            
            // Show target
            const targetView = document.getElementById(`view-${viewName}`);
            const targetNav = document.getElementById(`nav-${viewName}`);
            if (targetView) targetView.classList.add('active');
            if (targetNav) targetNav.classList.add('active');
            
            if (viewName === 'knowledge') fetchMemories();
            else if (viewName === 'automation') fetchAutomation();
            else if (viewName === 'comms') fetchChats();
            else if (viewName === 'system') fetchKV();
            else if (viewName === 'operations') fetchLog();
        }

        async function fetchLog() {
            if (currentActiveView !== 'operations') return;
            try {
                const res = await fetch(`/api/log?page=${currentPage}&limit=20`);
                lastData = await res.json();
                renderCurrentData();
                if (lastData.stats) {
                    document.getElementById('stat-tasks').textContent = lastData.stats.total_tasks;
                    document.getElementById('stat-latency').textContent = (lastData.stats.avg_duration/1000).toFixed(1) + 's';
                    const resolved = lastData.log.filter(t => t.status === 'RESOLVED' && t.token_usage && t.duration_ms > 0);
                    if (resolved.length > 0) {
                        const tokens = resolved.reduce((s, t) => s + t.token_usage.completion, 0);
                        const ms = resolved.reduce((s, t) => s + t.duration_ms, 0);
                        document.getElementById('stat-tps').textContent = (tokens / (ms / 1000)).toFixed(1);
                    }
                }
                document.getElementById('current-page-num').textContent = currentPage;
                document.getElementById('total-records-count').textContent = lastData.total;
                statusIndicator.textContent = `SYNCED: ${new Date().toLocaleTimeString()}`;
            } catch (e) { statusIndicator.innerHTML = `<span class="text-red-500">OFFLINE</span>`; }
        }

        function renderCurrentData() {
            const query = searchBox.value.toLowerCase();
            logBody.innerHTML = lastData.log.filter(t => t.content.toLowerCase().includes(query)).map(t => {
                const hasWarning = t.status === 'RESOLVED' && checkIntentWarning(t.content, t.responses);
                const intentTag = `<span class="intent-tag tag-${(t.intent_category || 'GENERAL').toLowerCase()} mt-1 block w-fit">${t.intent_category || 'GEN'}</span>`;
                return `<tr class="hover:bg-slate-800/40 group transition-colors ${hasWarning ? 'intent-mismatch' : ''}">
                    <td class="px-3 py-3 align-top">
                        <div class="flex flex-col">
                            <span class="text-slate-600 font-bold text-[10px]">${formatTime(t.created_at)}</span>
                            <span class="text-[8px] text-slate-700 font-mono mt-1 cursor-pointer hover:text-emerald-500" onclick="openTaskInspector('${t.id}')">#${t.id.slice(0,8)}</span>
                        </div>
                    </td>
                    <td class="px-3 py-3 align-top">${getStatusBadge(t.status, hasWarning, t.id)}</td>
                    <td class="px-3 py-3 align-top">${getDurationBadge(t.duration_ms, t.token_usage, hasWarning, t.telemetry)}</td>
                    <td class="px-3 py-3 align-top">${renderSession(t.session_id)}</td>
                    <td class="px-3 py-3 align-top font-mono text-[10px] text-slate-500">${t.origin_ip || 'LOCAL'}${intentTag}</td>
                    <td class="px-3 py-3 align-top text-slate-300 w-[20%] text-[11px]">${renderQuestion(t.content)}</td>
                    <td class="px-3 py-3 align-top w-[60%]">${renderResponses(t.responses, t.attachments, t.id, t.created_at)}</td>
                </tr>`;
            }).join('');
        }

        async function fetchMemories() {
            const res = await fetch('/api/memories');
            const data = await res.json();
            document.getElementById('memory-container').innerHTML = data.map(m => `<div class="data-card border-l-4 border-emerald-500"><div class="flex justify-between mb-2 text-[10px] font-black uppercase text-slate-500"><span>${m.category}</span><span>${formatTime(m.created_at)}</span></div><p class="text-sm italic text-slate-200">"${m.fact}"</p></div>`).join('');
        }

        async function fetchAutomation() {
            const res = await fetch('/api/tasks');
            const data = await res.json();
            document.getElementById('task-container').innerHTML = data.tasks.map(t => `<div class="data-card border-l-4 border-sky-500"><div class="flex justify-between mb-2 font-black uppercase text-[10px]"><span class="${t.status === 'active' ? 'text-emerald-400' : 'text-slate-600'}">${t.status}</span><span>${t.schedule_type}</span></div><div class="text-[11px] text-slate-400 font-bold truncate">${t.id}</div><p class="text-xs text-slate-500 italic mt-2">"${t.prompt}"</p></div>`).join('');
            document.getElementById('task-runs-container').innerHTML = `<table class="w-full text-[10px] divide-y divide-slate-800/50">${data.runs.map(r => `<tr><td class="px-4 py-2 font-mono">${formatTime(r.run_at)}</td><td class="px-4 py-2 text-slate-500">#${r.task_id.slice(0,8)}</td><td class="px-4 py-2 font-black ${r.status === 'success' ? 'text-emerald-400' : 'text-rose-500'}">${r.status}</td><td class="px-4 py-2 truncate">${r.result || r.error}</td></tr>`).join('')}</table>`;
        }

        async function fetchChats() {
            const res = await fetch('/api/chats');
            const data = await res.json();
            document.getElementById('chat-list').innerHTML = data.map(c => `<div class="p-5 border-b border-slate-900 hover:bg-slate-900/50 cursor-pointer" onclick="fetchMessages('${c.jid}', '${c.name || c.jid}')"><div class="flex justify-between text-xs font-bold text-slate-300"><span>${c.name || 'Node'}</span><span class="text-[8px] text-slate-600">${formatTime(c.last_message_time)}</span></div><div class="text-[9px] text-slate-600 font-mono truncate mt-1">${c.jid}</div></div>`).join('');
        }

        async function fetchMessages(jid, name) {
            document.getElementById('active-chat-header').innerHTML = `<div class="text-sm font-bold text-emerald-500 uppercase">${name}</div>`;
            const res = await fetch(`/api/messages/${encodeURIComponent(jid)}`);
            const data = await res.json();
            document.getElementById('message-container').innerHTML = data.map(m => `<div class="flex ${m.from_me ? 'justify-end' : 'justify-start'}"><div class="max-w-[75%] ${m.from_me ? 'bg-emerald-950/20 border-emerald-900/50' : 'bg-slate-900 border-slate-800'} border p-4 rounded-xl text-sm text-slate-300">${m.content}<div class="text-[8px] text-slate-600 mt-2 text-right">${formatTime(m.timestamp)}</div></div></div>`).join('');
        }

        async function fetchKV() {
            const res = await fetch('/api/kv');
            const data = await res.json();
            document.getElementById('kv-container').innerHTML = data.map(kv => `<tr><td class="px-8 py-4 font-black text-slate-500 uppercase text-xs">${kv.key}</td><td class="px-8 py-4 text-emerald-500 font-bold">${kv.value}</td></tr>`).join('');
        }

        function formatTime(iso) { return new Date(iso).toLocaleTimeString('zh-CN', { hour12: false }); }
        function closeDrawer() { drawer.classList.remove('open'); }
        function changePage(delta) { currentPage = Math.max(1, currentPage + delta); fetchLog(); }

        function checkIntentWarning(q, r) {
            if (!INTENT_KEYWORDS.some(kw => q.toLowerCase().includes(kw))) return false;
            return !r || !r.some(res => ACTION_TYPES.includes(res.type));
        }

        function getStatusBadge(s, w, id) {
            let cls = s === 'PENDING' ? 'bg-amber-950/50 text-amber-400 border-amber-800/50' : (w ? 'bg-red-950 text-white border-red-500 animate-pulse' : 'bg-emerald-950/50 text-emerald-400 border-emerald-800/50');
            return `<div class="flex flex-col gap-1 items-center w-full"><div class="px-2 py-0.5 rounded border ${cls} text-[9px] font-black text-center w-full uppercase tracking-widest">${s === 'PENDING' ? 'RUN' : (w ? 'MISSING' : 'DONE')}</div><button onclick="retryTask('${id}')" class="text-[8px] text-slate-600 hover:text-white uppercase font-bold">‚Ü∫ RETRY</button></div>`;
        }

        function getDurationBadge(ms, usage, w, tel) {
            if (!ms) return '-';
            let bar = ''; if (usage && usage.total > 0) { const p = (usage.prompt/usage.total)*100; bar = `<div class="flex w-full h-1 bg-slate-800 rounded-full mt-1 overflow-hidden"><div class="bg-emerald-500 h-full" style="width: ${p}%"></div><div class="bg-blue-500 h-full" style="width: ${100-p}%"></div></div>`; }
            return `<div class="flex flex-col cursor-help w-full" onclick="openPerformanceWaterfall('${btoa(JSON.stringify(tel))}', ${ms})"><span class="text-[11px] font-bold ${ms > 15000 ? 'text-amber-400' : 'text-emerald-400'}">${(ms/1000).toFixed(1)}s</span><span class="text-[8px] text-slate-600 mt-0.5">${usage ? (usage.total/1000).toFixed(1)+'k' : '-'} tok</span>${bar}</div>`;
        }

        function renderResponses(rs, att, pid, st) {
            if (!rs || rs.length === 0) return '<span class="text-slate-700 italic text-[10px]">Thinking...</span>';
            const bt = new Date(st).getTime();
            return `<div class="space-y-1">${rs.map(r => {
                const d = ((new Date(r.created_at).getTime() - bt) / 1000).toFixed(1);
                let b = r.content.startsWith('[Status]') ? 'STEP' : (r.type === 'Image' ? 'VISUAL' : (r.type === 'File' ? 'FILE' : (r.type === 'Audio' ? 'VOICE' : '')));
                let c = r.content.startsWith('[Status]') ? r.content.replace('[Status]', '').trim() : r.content;
                return `<div class="flex justify-between items-start gap-2 group/node"><div class="text-[11px] text-slate-400 line-clamp-1 hover:line-clamp-none cursor-pointer flex-1">${b ? `<span class="text-[8px] bg-slate-800 px-1 rounded mr-1">${b}</span>` : ''}<span>${c}</span></div><span class="text-[8px] text-slate-700 opacity-0 group-hover/node:opacity-100 font-mono">+${d}s</span></div>`;
            }).join('')}</div>`;
        }

        function renderQuestion(q) {
            if (!q) return '';
            let s = q.replace(/</g, '&lt;');
            s = s.replace(/\[IMAGE: (.*?)\]/g, '<span class="bg-purple-950/50 text-purple-400 text-[8px] px-1 rounded border border-purple-500/30 mr-1">IMG</span>');
            return s;
        }

        function renderSession(sid) { return `<div class="text-[11px] font-bold text-sky-400 truncate cursor-pointer hover:underline" onclick="switchView('comms'); fetchMessages('${sid}', '${sid}')">${sid.slice(0,4)}...${sid.slice(-4)}</div>`; }

        function openPerformanceWaterfall(b, t) {
            const tel = JSON.parse(atob(b));
            drawerTitle.textContent = 'ÊÄßËÉΩÁªÜÂàÜ';
            const p = (v) => ((v/t)*100).toFixed(1)+'%';
            drawerContent.innerHTML = `<div class="bg-slate-900 p-6 rounded-xl border border-slate-800"><div class="flex justify-between text-[10px] font-black mb-4 uppercase"><span>Timeline</span><span>${(t/1000).toFixed(2)}s</span></div><div class="flex h-6 bg-slate-950 rounded-full overflow-hidden border border-slate-800 p-1 gap-1"><div class="perf-pre h-full" style="width: ${p(tel.pre)}"></div><div class="perf-llm h-full" style="width: ${p(tel.llm)}"></div><div class="perf-post h-full" style="width: ${p(tel.post)}"></div></div><div class="grid grid-cols-3 mt-6 text-[10px]"><div class="border-l border-emerald-500/30 pl-2">È¢ÑÂ§ÑÁêÜ<div>${(tel.pre/1000).toFixed(2)}s</div></div><div class="border-l border-blue-500/30 pl-2">Ê®°ÂûãÊé®ÁêÜ<div>${(tel.llm/1000).toFixed(2)}s</div></div><div class="border-l border-amber-500/30 pl-2">Â∑•ÂÖ∑ÊâßË°å<div>${(tel.post/1000).toFixed(2)}s</div></div></div></div>`;
            drawer.classList.add('open');
        }

        async function retryTask(id) {
            await fetch('/api/retry', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
            statusIndicator.textContent = 'TASK_REQUEUED';
        }

        function openTaskInspector(id) {
            const t = lastData.log.find(x => x.id === id);
            drawerTitle.textContent = `Inspector: ${id.slice(0,8)}`;
            drawerContent.innerHTML = `<div class="space-y-6"><section><h3 class="text-[10px] text-slate-500 uppercase font-black border-l-2 border-emerald-500 pl-2 mb-2">Payload</h3><div class="bg-slate-950 p-4 rounded border border-slate-800 font-mono text-xs whitespace-pre-wrap">${t.content}</div></section><section><h3 class="text-[10px] text-slate-500 uppercase font-black border-l-2 border-blue-500 pl-2 mb-2">Usage</h3><div class="grid grid-cols-3 gap-2">${['prompt','completion','total'].map(k => `<div class="bg-slate-900 p-3 rounded border border-slate-800 text-center"><div class="text-[8px] text-slate-600 uppercase">${k}</div><div class="text-sm font-bold text-slate-300">${t.token_usage?.[k] || 0}</div></div>`).join('')}</div></section></div>`;
            drawer.classList.add('open');
        }

        setInterval(fetchLog, 3000); fetchLog();
    </script>
</body>
</html>